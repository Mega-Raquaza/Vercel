import{b as S,r as n,A as _,u as k,j as r,a as y}from"./index-D4ATXNzv.js";import{l as C}from"./index-Rnf9BJUB.js";const f="http://localhost:5000",l=(a,e)=>!a||!e?(console.error("Missing IDs for room generation:",a,e),"default"):[a,e].sort().join("_"),$=()=>{const{friendId:a}=S(),{user:e}=n.useContext(_),[i,b]=n.useState(null),[c,d]=n.useState([]),[u,m]=n.useState(""),[g,p]=n.useState(null),j=k();n.useEffect(()=>{if(!a)return;(async()=>{try{const t=await y.get(`${f}/api/profile/${a}`,{headers:{Authorization:`Bearer ${localStorage.getItem("accessToken")}`},withCredentials:!0});p(t.data.profile)}catch(t){console.error("Error fetching friend's profile:",t)}})()},[a]),n.useEffect(()=>{if(!e||!a)return;const s=l(e._id,a);(async()=>{try{const o=await y.get(`${f}/api/messages?room=${s}`,{headers:{Authorization:`Bearer ${localStorage.getItem("accessToken")}`},withCredentials:!0});d(o.data.messages)}catch(o){console.error("Error fetching message history:",o)}})()},[a,e]),n.useEffect(()=>{if(!e||!a)return;const s=l(e._id,a),t=C(f,{query:{userId:e._id,friendId:a,room:s}});return b(t),t.on("connect",()=>{console.log("Connected to chat server:",t.id),t.emit("userConnected",{userId:e._id})}),t.on("message",o=>{console.log("Received message:",o),d(h=>[...h,o])}),t.on("messageRead",({messageId:o,reader:h})=>{d(w=>w.map(x=>x._id===o?{...x,status:"read"}:x))}),()=>{t.disconnect(),console.log("Disconnected from chat server")}},[a,e]);const v=s=>{if(s.preventDefault(),!u.trim()||!i||!e)return;const o={room:l(e._id,a),sender:e._id,receiver:a,text:u,status:"sent"};i.emit("message",o),m("")};n.useEffect(()=>{if(!i||!e)return;const s=l(e._id,a);c.forEach(t=>{t.receiver===e._id&&t.status!=="read"&&i.emit("messageRead",{messageId:t._id,room:s,reader:e._id})})},[c,i,e,a]);const N=(s,t)=>{const o=s.sender===e._id||s.sender===e.username;return r.jsx("div",{className:`flex mb-2 ${o?"justify-end":"justify-start"}`,children:r.jsxs("div",{className:`p-3 rounded-lg max-w-xs break-words relative ${o?"bg-green-600 text-white":"bg-gray-700 text-white shadow"}`,children:[!o&&r.jsx("div",{className:"text-xs font-bold mb-1",children:s.sender}),r.jsx("div",{className:"text-sm",children:s.text}),r.jsxs("div",{className:"text-xs text-gray-300 mt-1 text-right",children:[new Date(s.createdAt||Date.now()).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),o&&r.jsx("span",{className:"ml-2",children:s.status==="read"?r.jsx("i",{className:"fas fa-check-double text-blue-400"}):s.status==="delivered"?r.jsx("i",{className:"fas fa-check-double text-gray-400"}):r.jsx("i",{className:"fas fa-check text-gray-300"})})]})]})},t)};return r.jsxs("div",{className:"max-w-5xl mx-auto flex flex-col min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white",children:[r.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-700",children:[r.jsx("button",{onClick:()=>j(-1),className:"px-4 py-2 text-white hover:text-gray-300",children:"Back"}),r.jsx("div",{className:"flex flex-col items-center",children:r.jsxs("h1",{className:"text-3xl font-bold",children:["Chat with ",g?g.username:"Friend"]})}),r.jsx("div",{})]}),r.jsx("div",{className:"flex-1 p-4 overflow-y-auto mb-4 bg-gray-800 rounded-lg border border-gray-700",children:c.length===0?r.jsx("p",{className:"text-center text-gray-400 mt-4",children:"No messages yet."}):c.map((s,t)=>N(s,t))}),r.jsxs("form",{onSubmit:v,className:"flex items-center p-4 bg-gray-800 border-t border-gray-700",children:[r.jsx("input",{type:"text",value:u,onChange:s=>m(s.target.value),className:"flex-1 p-3 bg-gray-700 border border-gray-600 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-600 text-white",placeholder:"Type your message..."}),r.jsx("button",{type:"submit",className:"px-4 py-3 bg-green-600 text-white rounded-r-lg hover:bg-green-700 transition",children:"Send"})]})]})};export{$ as default};
